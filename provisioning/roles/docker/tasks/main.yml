# configure proxy settings if enabled
- name: create dropin directory
  file:
    path: "/etc/systemd/system/docker.service.d"
    state: "directory"
    mode: 0750
    owner: root
    group: root
  when: docker_proxy_enabled == true

- name: add systemd dropin for proxy
  template:
    src: "proxy.conf.j2"
    dest: "/etc/systemd/system/docker.service.d/proxy.conf"
    mode: 0640
    owner: root
    group: root
  when: docker_proxy_enabled == true
  notify: reload and restart systemd docker

- meta: flush_handlers

- name: get transparent proxy container id
  shell: docker ps -q -f name=transparent-proxy
  register: transparent_proxy_id

- name: launch transparent proxy container
  command: "docker run -d --restart always --privileged -e HTTP_PROXY={{ proxy.host }}:{{ proxy.port }} -e NO_PROXY={{ no_proxy }} --net=host --name transparent-proxy fengzhou/transparent-proxy"
  when: docker_proxy_enabled == true and transparent_proxy_id.stdout == ""
